<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #e5e7eb;
    }
    .layout {
      display: flex;
      height: 100vh;
    }
    /* Left sidebar */
    .sidebar {
      width: 210px;
      background: #0f172a;
      color: white;
      display: flex;
      flex-direction: column;
    }
    .sidebar-top {
      padding: 14px;
    }
    .sidebar-bottom {
      margin-top: auto;
      padding: 14px;
      background: #ffffff;
      color: #000;
    }
    #new-chat {
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.12);
      color: #e5e7eb;
      border: 1px solid rgba(255, 255, 255, 0.16);
      font-weight: 600;
    }
    #new-chat:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    #chat-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .history-item,
    .history-empty {
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.08);
      color: #e5e7eb;
      font-size: 12px;
      line-height: 1.3;
    }
    .history-item {
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.08);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: background .12s ease, transform .08s ease, border-color .12s ease;
    }
    .history-item:hover {
      background: rgba(255, 255, 255, 0.16);
      border-color: rgba(255, 255, 255, 0.2);
    }
    .history-item.active {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.28);
      transform: translateY(1px);
    }
    .history-empty {
      color: rgba(229, 231, 235, 0.8);
      white-space: normal;
    }
    .btn {
      background: #e2e8f0;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
    }
    .btn-danger {
      background: #f43f5e;
      color: #fff;
    }
    /* Top bar */
    .topbar {
      height: 50px;
      background: #ffffff;
      border-bottom: 1px solid #d1d5db;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .dashboard-panel {
      position: relative;
      transition: transform .08s ease-out, box-shadow .08s ease-out, filter .08s ease-out;
    }
    .dashboard-panel.is-hold {
      transform: translateY(1px);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.12);
      filter: brightness(0.98);
    }
    .bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 14px;
      white-space: pre-wrap;
      box-shadow: 0 1px 0 rgba(15, 23, 42, 0.06);
    }
    .bubble.user {
      align-self: flex-end;
      background: #2563eb;
      color: #fff;
    }
    .bubble.assistant {
      align-self: flex-start;
      background: #fff;
      color: #0f172a;
    }
    .bubble.error {
      align-self: flex-start;
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }
    .bubble.thinking {
      opacity: 0.7;
      font-style: italic;
    }
    .verify-ok { color: #22c55e; font-size: 12px; }
    .verify-no { color: #f97316; font-size: 12px; }
  </style>
</head>
<body>
    <div class="layout">
        <!-- Left sidebar -->
        <aside class="sidebar">
            <div class="sidebar-top">
                <div style="font-weight:700; margin-bottom:10px;">Chat History</div>
                <button id="new-chat" class="btn" style="width:100%;">New chat</button>
            </div>
            <!-- Chat list can go here later -->
            <div id="chat-list" style="padding:0 14px; flex:1; overflow:auto;"></div>

            <div class="sidebar-bottom">
                <div>Your account</div>
                <div id="acc-email" style="word-break:break-all;"></div>
                <div id="acc-verified"></div>
                <button id="btn-verify" class="btn" style="width:100%; margin-top:6px; background:#9ca3af; color:white;">Verify email</button>
                <button id="btn-logout" class="btn btn-danger" style="width:100%; margin-top:6px;">Logout</button>
            </div>
        </aside>

        <!-- Right main area -->
        <div class="main">
            <!-- Top bar -->
            <header class="topbar">
                <div style="font-weight:600;">Voice-Enabled AI Assistant for Bioengineering Department Policy</div>
                <div id="badge">Ready</div>
            </header>

            <!-- Main chat area -->
            <div id="dashboard-panel" class="dashboard-panel" style="flex:1; display:flex; flex-direction:column; background:#dcdfe4;">
                <!-- Message list -->
                <div id="chat-messages" style="
          flex:1;
          overflow-y:auto;
          padding:20px;
          display:flex;
          flex-direction:column;
          gap:12px;
        ">
                    <!-- JS will insert demo messages -->
                </div>

                <!-- Input bar -->
                <div id="chat-input-bar" style="
          display:flex;
          gap:10px;
          padding:12px 16px;
          background:#fff;
          border-top:1px solid #d1d5db;
        ">
                    <input id="chat-input" type="text" placeholder="Message the assistant..." style="
            flex:1;
            padding:8px 12px;
            border:1px solid #d1d5db;
            border-radius:999px;
            outline:none;
          " />
                    <button id="chat-mic" class="btn" style="width:40px; border-radius:999px; background:#e5e7eb;">ðŸŽ¤</button>
                    <button id="chat-send" class="btn btn-primary" style="border-radius:999px;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Your existing firebase-auth.js must load before our scripts -->
    <script src="/js/firebase-auth.js"></script>
    <script src="/js/app.js"></script>

    <script>
        function initHoldEffect() {
            const panel = document.getElementById('dashboard-panel');
            if (!panel) return;

            const setHold = (on) => {
                panel.classList.toggle('is-hold', on);
            };

            panel.addEventListener('pointerdown', () => setHold(true));
            panel.addEventListener('pointerup', () => setHold(false));
            panel.addEventListener('pointerleave', () => setHold(false));
            panel.addEventListener('pointercancel', () => setHold(false));
        }

        /* Chat bubble rendering */
        function addChatBubble(role, text) {
            const box = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.style.maxWidth = '70%';
            div.style.padding = '10px 14px';
            div.style.borderRadius = '14px';
            div.style.whiteSpace = 'pre-wrap';

            if (role === 'user') {
                div.style.alignSelf = 'flex-end';
                div.style.background = '#2563eb';
                div.style.color = '#fff';
            } else {
                div.style.alignSelf = 'flex-start';
                div.style.background = '#fff';
                div.style.color = '#0f172a';
            }

            div.textContent = text;
            box.appendChild(div);
            // Scroll to bottom
            box.scrollTop = box.scrollHeight;
        }

        /* Demo data */
        function seedFakeChat(userEmail) {
            addChatBubble('assistant', 'Hi ' + (userEmail || 'there') + ', I am your AI assistant on WEB.');
            addChatBubble('user', 'Can you summarise my tasks today?');
            addChatBubble('assistant', 'Sure:\\n1) Finish web dashboard\\n2) Hook Firebase auth\\n3) Test voice input');
        }

        /* Voice input */
        function initVoiceInput() {
            const micBtn = document.getElementById('chat-mic');
            const input = document.getElementById('chat-input');
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                micBtn.disabled = true;
                micBtn.title = 'Browser not supported';
                return;
            }
            const recog = new SpeechRecognition();
            recog.lang = 'en-US';
            recog.continuous = false;
            recog.interimResults = false;

            let listening = false;
            recog.onresult = (e) => {
                const transcript = Array.from(e.results).map(r => r[0].transcript).join(' ');
                input.value = (input.value + ' ' + transcript).trim();
            };
            recog.onend = () => {
                listening = false;
                micBtn.textContent = 'ðŸŽ¤';
            };

            micBtn.addEventListener('click', () => {
                if (listening) {
                    recog.stop();
                    return;
                }
                listening = true;
                micBtn.textContent = 'âº';
                try { recog.start(); } catch (e) { }
            });
        }

        /* Send button */
        function initSend() {
            const input = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send');

            function doSend() {
                const text = input.value.trim();
                if (!text) return;
                addChatBubble('user', text);
                input.value = '';
                // Demo reply
                setTimeout(() => {
                    addChatBubble('assistant', 'Demo reply: ' + text.toUpperCase());
                }, 400);
            }

            sendBtn.addEventListener('click', doSend);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    doSend();
                }
            });
        }

        /* Page logic */
        (async function () {
            // 1. Check login state; redirect to login if missing
            const user = fbGetCurrentUser();
            if (!user) {
                window.location.href = '/login.html';
                return;
            }

            // 2. Check email verification via Firebase token
            let info;
            try {
                info = await fbLookup(user.idToken);
            } catch (e) {
                fbSignOut();
                window.location.href = '/login.html';
                return;
            }

            // 3. Fill account info in the bottom-left
            document.getElementById('acc-email').textContent = user.email;
            const verEl = document.getElementById('acc-verified');
            const btnVerify = document.getElementById('btn-verify');

            if (info.emailVerified) {
                verEl.textContent = 'Verified';
                verEl.className = 'verify-ok';
                btnVerify.disabled = true;
            } else {
                verEl.textContent = 'Not verified';
                verEl.className = 'verify-no';
                btnVerify.disabled = false;
            }

            // Send verification email
            btnVerify.addEventListener('click', async () => {
                try {
                    await fbSendVerify(user.idToken);
                    alert('Verification email sent.');
                } catch (err) {
                    alert(err.message);
                }
            });

            // Sign out
            document.getElementById('btn-logout').addEventListener('click', () => {
                fbSignOut();
                window.location.href = '/login.html';
            });

            // 4. Initialize chat UI
            // seedFakeChat(user.email);
            // initVoiceInput();
            // initSend();
            initHoldEffect();
        })();
    </script>
</body>
</html>
