<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">

  <aside class="sidebar">
    <div class="row">
      <div class="brand">AI Assistant</div>
      <div class="space"></div>
      <button id="new-chat" class="btn primary" style="padding: 4px 8px; font-size: 12px;">+ New</button>
    </div>

    <div id="chat-list" class="history">
      <div class="history-item active">
        <div>Current Session</div>
        <div class="muted" style="font-size: 12px;">Now</div>
      </div>
    </div>

    <div class="space"></div>

    <div style="border-top: 1px solid #222; padding-top: 12px;">
      <div class="row">
        <div class="muted" style="font-size: 12px;">Account</div>
      </div>
      <div class="row" style="margin-bottom: 8px;">
        <div id="acc-email" class="text" style="font-size: 14px; overflow: hidden; text-overflow: ellipsis;">Loading...</div>
      </div>

      <div class="row" style="margin-bottom: 8px;">
        <div id="acc-verified" class="badge">Checking...</div>
      </div>

      <div style="display: flex; flex-direction: column; gap: 6px;">
        <button id="btn-verify" class="btn" style="font-size: 12px;">Verify Email</button>
        <button id="btn-logout" class="btn danger" style="font-size: 12px;">Logout</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <header class="chat-header">
      <span class="brand">Chat with AI</span>
      <div class="space"></div>
      <div id="badge" class="usage ok">...</div>
    </header>

    <div id="chat-messages" class="messages">
      </div>

    <div class="composer">
      <div id="chat-mic" class="mic" style="cursor: pointer;">ğŸ¤</div>

      <input id="chat-input" type="text" class="input" placeholder="Message ChatGPTâ€¦">

      <button id="chat-send" class="btn primary">Send</button>
    </div>
  </main>
</div>

<script src="firebase-auth.js"></script>

<script>
  /* ---------- èŠå¤©æ°”æ³¡æ¸²æŸ“ (å·²ä¿®æ”¹é€‚é… CSS) ---------- */
  function addChatBubble(role, text) {
    const box = document.getElementById('chat-messages');
    const div = document.createElement('div');

    // å…³é”®ä¿®æ”¹ï¼šä¸å†ä½¿ç”¨å†…è”æ ·å¼ï¼Œè€Œæ˜¯ä½¿ç”¨ CSS ç±»å
    // å¯¹åº” style.css ä¸­çš„ .bubble, .bubble.user, .bubble.assistant
    div.className = `bubble ${role === 'user' ? 'user' : 'assistant'}`;

    div.textContent = text;
    box.appendChild(div);
    // æ»šåˆ°åº•
    box.scrollTop = box.scrollHeight;
  }

  /* ---------- å‡æ•°æ® ---------- */
  function seedFakeChat(userEmail) {
    addChatBubble('assistant', 'Hi ' + (userEmail || 'there') + ', I am your AI assistant.');
    addChatBubble('user', 'Can you summarise my tasks today?');
    addChatBubble('assistant', 'Sure:\n1) Finish web dashboard\n2) Hook Firebase auth\n3) Test voice input');
  }

  /* ---------- è¯­éŸ³è¾“å…¥ ---------- */
  function initVoiceInput() {
    const micBtn = document.getElementById('chat-mic');
    const input = document.getElementById('chat-input');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      micBtn.style.opacity = '0.5';
      micBtn.title = 'Browser not supported';
      return;
    }

    const recog = new SpeechRecognition();
    recog.lang = 'en-US';
    recog.continuous = false;
    recog.interimResults = false;

    let listening = false;

    recog.onresult = (e) => {
      const transcript = Array.from(e.results).map(r => r[0].transcript).join(' ');
      input.value = (input.value + ' ' + transcript).trim();
    };

    recog.onend = () => {
      listening = false;
      micBtn.style.border = 'none'; // ç§»é™¤å½•éŸ³çŠ¶æ€æ ·å¼
      micBtn.textContent = 'ğŸ¤';
    };

    micBtn.addEventListener('click', () => {
      if (listening) {
        recog.stop();
        return;
      }
      listening = true;
      micBtn.textContent = 'âº';
      micBtn.style.border = '1px solid #ef4444'; // ç®€å•çš„å½•éŸ³ä¸­è§†è§‰åé¦ˆ
      try { recog.start(); } catch (e) {}
    });
  }

  /* ---------- å‘é€æŒ‰é’® ---------- */
  function initSend() {
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send');

    function doSend() {
      const text = input.value.trim();
      if (!text) return;

      addChatBubble('user', text);
      input.value = '';

      // æ¨¡æ‹Ÿæ­£åœ¨è¾“å…¥...
      setTimeout(() => {
        addChatBubble('assistant', 'Demo reply: ' + text.toUpperCase());
      }, 600);
    }

    sendBtn.addEventListener('click', doSend);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        doSend();
      }
    });
  }

  /* ---------- é¡µé¢ä¸»é€»è¾‘ ---------- */
  (async function () {
    // 1. å…ˆçœ‹æœ‰æ²¡æœ‰ç™»å½•ï¼Œæ²¡æœ‰å°±å› login
    const user = fbGetCurrentUser();
    if (!user) {
      window.location.href = 'login.html';
      return;
    }

    // 2. ç”¨ token å» Firebase æŸ¥æ˜¯ä¸æ˜¯ verified
    let info;
    try {
      info = await fbLookup(user.idToken);
    } catch (e) {
      // å‡ºé”™å¯èƒ½ token è¿‡æœŸ
      fbSignOut();
      window.location.href = 'login.html';
      return;
    }

    // 3. å¡«å·¦ä¸‹è§’è´¦å·ä¿¡æ¯
    document.getElementById('acc-email').textContent = user.email;
    const verEl = document.getElementById('acc-verified');
    const btnVerify = document.getElementById('btn-verify');

    if (info.emailVerified) {
      verEl.textContent = 'Verified';
      // ä½¿ç”¨ CSS ä¸­çš„é¢œè‰²å˜é‡ç±»
      verEl.className = 'badge';
      verEl.style.color = 'var(--ok)';
      verEl.style.borderColor = 'var(--ok)';
      btnVerify.disabled = true;
    } else {
      verEl.textContent = 'Unverified';
      verEl.className = 'badge';
      verEl.style.color = 'var(--danger)';
      verEl.style.borderColor = 'var(--danger)';
      btnVerify.disabled = false;
    }

    // ç‚¹éªŒè¯é‚®ä»¶
    btnVerify.addEventListener('click', async () => {
      try {
        await fbSendVerify(user.idToken);
        alert('Verification email sent.');
      } catch (err) {
        alert(err.message);
      }
    });

    // é€€å‡º
    document.getElementById('btn-logout').addEventListener('click', () => {
      fbSignOut();
      window.location.href = 'login.html';
    });

    // 4. åˆå§‹åŒ–èŠå¤©ç•Œé¢
    seedFakeChat(user.email);
    initVoiceInput();
    initSend();
  })();
</script>
<script src="app.js"></script>
</body>
</html>